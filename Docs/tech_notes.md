# 技术细节

## 初始化

### 单人初始化

- 初始化贪吃蛇数组、移动方向、得分
- 获取游戏难度
- 进入游戏循环

### 双人初始化

- 初始化两个贪吃蛇数组、两个移动方向
- 获取游戏难度
- 进入游戏循环（多传入一个`id`参数用于区分）

## 游戏循环

使用`setInterval`根据游戏难度循环执行`moveSnake`、`drawGame`、`checkCollision`

### moveSnake移动贪吃蛇

#### 单人移动

- 提取移动方向
- 根据蛇头的当前位置以及移动方向获取蛇头更新位置`head`
- 将`head`添加到贪吃蛇数组首位，判断是否吃到食物，未吃到则删除末位，否则保留末位

#### 双人移动

- 提取移动方向
- 更新两个蛇头的位置
- 判断两名玩家是否吃到食物：
   1. 均未吃到则都删除末位
   2. 吃到的一方不删除末位

### drawGame绘制游戏

使用`clearRect`清除画布并调用`drawSnake`绘制贪吃蛇，调用`drawFood`绘制食物

### drawSnake绘制贪吃蛇

遍历贪吃蛇数组，获取xy坐标并依次绘制20x20的绿色方块

### drawFood绘制食物

根据食物的xy坐标绘制红色方块

### checkCollision检测碰撞

#### 单人检测

- 检查蛇头是否触碰到地图边界
- 检查蛇头是否触碰到蛇身：

   ```js
   <!-- `snake1`是数组，`slice(1)`遍历索引从1开始到最后一个元素，`some`只要一个满足条件就返回`true` -->
   snake1.slice(1).some(segment => segment.x === snake1[0].x && segment.y === snake1[0].y));
   ```

- 如果上述条件有一个满足则触发`gameOver`

#### 双人检测

在单人模式的基础之上，判断一方玩家的蛇头是否触碰到另一方玩家的蛇身，触碰到则触发gameOver(id)（id为1代表玩家1失败；id为2代表玩家2失败）

### gameOver游戏结束

#### 单人结束

- 调用`clearInterval`清除计时器
- 判断是否更新最高得分
- 输出玩家得分并重置得分
- 吃实话贪吃蛇数组以及移动方向
- 调用drawGame重新绘制游戏
- 启用开始按钮

#### 双人结束

- 根据id判断哪方获胜
- 修改`上局胜方`并输出胜方
- 初始化两名玩家的贪吃蛇数组以及移动方向
- 绘制游戏
- 启用开始按钮

## 按钮逻辑

### startBtn开始游戏

- `click`事件触发
- 调用`clearInterval`清除计时器
- 根据玩家选择的模式初始化单人游戏或双人游戏
- 禁用开始按钮

### resetBtn重新开始

- `click`事件触发
- 调用`clearInterval`清除计时器
- 启用开始按钮
- 初始化得分与贪吃蛇数组
- 根据玩家选择的模式绘制单人游戏或双人游戏地图

### speedSelect选择游戏难度

- `change`事件触发
- 调用`clearInterval`清除计时器
- 启用开始按钮
- 初始化得分与贪吃蛇数组
- 根据玩家选择的模式绘制单人游戏或双人游戏地图

### modeSelect选择游戏模式

- `change`事件触发
- 调用`clearInterval`清除计时器
- 启用开始按钮
- 初始化得分与贪吃蛇数组
- 切换后为双人模式：删除得分元素并修改`最高得分`为`上局胜方`，绘制游戏地图
- 切换后为单人模式：恢复得分元素并修改`上局胜方`为`最高得分`，同时在`最高得分`的div中新建`span`元素，恢复之前的最高得分，绘制游戏地图

## 方向缓冲区

- 使用`directionQueue`数组记录贪吃蛇的移动方向
- 当玩家按下方向键时，判断是否满足下列条件之一：
  1. 缓冲区为空并且该方向的速度为0
  2. 缓冲区不为空并且缓冲区最后一个移动方向与当前按下的方向垂直
- `moveSnake`中不断取出缓冲区的第一个元素用于更新贪吃蛇方向

## 刷新

刷新默认回到单人模式，直接调用`drawGame`绘制单人地图
